name: CI/CD Pipeline

on:
  push:
    branches:
      - master
      - release
    tags:
      - 'v*.*.*'
  pull_request:
    branches: 
      - release

env:
  PYTHON_VERSION: '3.10'
  
jobs:
  test:
    name: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ë°°í¬ í™˜ê²½ í™•ì¸
      run: |
        echo "ğŸ”— GitHub Ref: ${{ github.ref }}"
        echo "ğŸ“‹ Event Name: ${{ github.event_name }}"
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "ğŸ·ï¸  íƒœê·¸ ë°°í¬ ê°ì§€: ${{ github.ref }}"
        elif [[ "${{ github.ref }}" == "refs/heads/release" ]]; then
          echo "ğŸš€ Release ë¸Œëœì¹˜ ë°°í¬: ${{ github.ref }}"
        else
          echo "ğŸ”§ ê¸°íƒ€ í™˜ê²½: ${{ github.ref }}"
        fi

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (ì„ì‹œ ë¹„í™œì„±í™”)
    # - name: ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (flake8)
    #   run: |
    #     pip install flake8
    #     # ê¸°ë³¸ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (ë¼ì¸ ê¸¸ì´ 88ì, ì¼ë¶€ ì˜¤ë¥˜ ë¬´ì‹œ)
    #     flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
    #     flake8 app/ --count --max-line-length=88 --statistics

    - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (í•µì‹¬ API ì—”ë“œí¬ì¸íŠ¸)
      env:
        # í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ë³€ìˆ˜
        ENVIRONMENT: test
        GITHUB_REF: ${{ github.ref }}  # ğŸ¯ ë¸Œëœì¹˜/íƒœê·¸ ì •ë³´ ì „ë‹¬
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        REDIS_URL: redis://localhost:6379  # ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© (Docker ComposeëŠ” ìì²´ Redis ì‚¬ìš©)
      run: |
        # í•µì‹¬ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰ (86ê°œ í…ŒìŠ¤íŠ¸ í†µê³¼ ê¸°ì¤€)
        python -m pytest tests/test_api/ -v --tb=short
        # Notion webhook í…ŒìŠ¤íŠ¸ ë³„ë„ ì‹¤í–‰ (ì¤‘ìš”)
        python -m pytest tests/test_api/notion_webhook_test.py -v
        echo "âœ… í•µì‹¬ API í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        
    - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ
      run: |
        pip install pytest-cov
        python -m pytest tests/test_api/ --cov=app --cov-report=xml --cov-report=term

    - name: Docker ë¹Œë“œ ê²€ì¦
      env:
        GITHUB_REF: ${{ github.ref }}  # ğŸ¯ ë¸Œëœì¹˜/íƒœê·¸ ì •ë³´ ì „ë‹¬
      run: |
        # Docker ì´ë¯¸ì§€ ë¹Œë“œ ê²€ì¦ë§Œ ìˆ˜í–‰
        echo "ğŸš€ Docker ì´ë¯¸ì§€ ë¹Œë“œ ê²€ì¦ ì‹œì‘..."
        echo "ğŸ“‹ ë¹Œë“œ ëŒ€ìƒ: $GITHUB_REF"
        
        # Dockerfile ë¹Œë“œ í…ŒìŠ¤íŠ¸
        echo "ğŸ“¦ FastAPI/RQ Worker ì´ë¯¸ì§€ ë¹Œë“œ..."
        docker build -f docker/for_ci/Dockerfile -t notion-app-test .
        
        # Docker Compose ë¹Œë“œ í…ŒìŠ¤íŠ¸ (ì‹¤í–‰í•˜ì§€ ì•Šê³  ë¹Œë“œë§Œ)
        if [ -f docker-compose.yml ]; then
          echo "ğŸ“¦ ë¡œì»¬ìš© Docker Compose ë¹Œë“œ ê²€ì¦..."
          docker compose build
          echo "âœ… ë¡œì»¬ìš© Docker Compose ë¹Œë“œ ì„±ê³µ"
        fi
        
        if [ -f docker-compose.ci.yml ]; then
          echo "ğŸ“¦ CIìš© Docker Compose ë¹Œë“œ ê²€ì¦..."
          docker compose -f docker-compose.ci.yml build
          echo "âœ… CIìš© Docker Compose ë¹Œë“œ ì„±ê³µ"
        fi
        
        # ë¹Œë“œëœ ì´ë¯¸ì§€ í™•ì¸
        echo "ğŸ” ë¹Œë“œëœ ì´ë¯¸ì§€ ëª©ë¡:"
        docker images | grep -E "(notion|redis)" || echo "ì´ë¯¸ì§€ í™•ì¸ ì™„ë£Œ"
        
        echo "âœ… Docker ë¹Œë“œ ê²€ì¦ ì™„ë£Œ"