name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  PYTHON_VERSION: '3.10'
  
jobs:
  # CI Îã®Í≥Ñ: ÌÖåÏä§Ìä∏Îßå (ÌòÑÏû¨ ÌôúÏÑ±Ìôî)
  test:
    name: üß™ Test & Quality Check
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 9091:9091
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: üì• ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      uses: actions/checkout@v4

    - name: üêç Python ÌôòÍ≤Ω ÏÑ§Ï†ï
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üì¶ ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # üîç ÏΩîÎìú Ïä§ÌÉÄÏùº Í≤ÄÏÇ¨ (ÌïÑÏöîÏãú ÌôúÏÑ±Ìôî)
    # - name: üîç ÏΩîÎìú Ïä§ÌÉÄÏùº Í≤ÄÏÇ¨ (flake8)
    #   run: |
    #     pip install flake8
    #     # Í∏∞Î≥∏ Ïä§ÌÉÄÏùº Í≤ÄÏÇ¨ (ÎùºÏù∏ Í∏∏Ïù¥ 88Ïûê, ÏùºÎ∂Ä Ïò§Î•ò Î¨¥Ïãú)
    #     flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
    #     flake8 app/ --count --max-line-length=88 --statistics

    - name: üß™ ÌÖåÏä§Ìä∏ Ïã§Ìñâ (ÌïµÏã¨ API ÏóîÎìúÌè¨Ïù∏Ìä∏)
      env:
        # ÌÖåÏä§Ìä∏Ïö© ÌôòÍ≤ΩÎ≥ÄÏàò
        ENVIRONMENT: test
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        REDIS_URL: redis://localhost:9091
      run: |
        # ÌïµÏã¨ ÌÖåÏä§Ìä∏Îßå Ïã§Ìñâ (86Í∞ú ÌÖåÏä§Ìä∏ ÌÜµÍ≥º Í∏∞Ï§Ä)
        python -m pytest tests/test_api/ -v --tb=short
        # Notion webhook ÌÖåÏä§Ìä∏ Î≥ÑÎèÑ Ïã§Ìñâ (Ï§ëÏöî)
        python -m pytest tests/test_api/notion_webhook_test.py -v
        echo "‚úÖ ÌïµÏã¨ API ÌÖåÏä§Ìä∏ ÏôÑÎ£å"
        
    - name: üìä ÌÖåÏä§Ìä∏ Ïª§Î≤ÑÎ¶¨ÏßÄ Î≥¥Í≥†ÏÑú
      run: |
        pip install pytest-cov
        python -m pytest tests/test_api/ --cov=app --cov-report=xml --cov-report=term

    - name: üê≥ Docker Compose RQ Worker ÌÜµÌï© ÌÖåÏä§Ìä∏ (Ïô∏Î∂Ä Redis ÏÇ¨Ïö©)
      env:
        REDIS_PASSWORD: ""  # GitHub Actions RedisÎäî ÎπÑÎ∞ÄÎ≤àÌò∏ ÏóÜÏùå
        SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'http://localhost:54321' }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY || 'test-service-key' }}
        OPENAI_API_KEY: test_key
        ANTHROPIC_API_KEY: test_key
      run: |
        # CI Ï†ÑÏö© docker composeÎ°ú RQ Worker ÌÜµÌï© ÌÖåÏä§Ìä∏
        if [ -f docker-compose.ci.yml ]; then
          echo "üöÄ RQ Worker ÌÜµÌï© ÌÖåÏä§Ìä∏ ÏãúÏûë..."
          
          # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨
          docker compose -f docker-compose.ci.yml down -v || true
          
          # Î®ºÏ†Ä Ïô∏Î∂Ä Redis Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
          echo "üîç Ïô∏Î∂Ä Redis Ïó∞Í≤∞ ÌÖåÏä§Ìä∏..."
          if redis-cli -h localhost -p 9091 ping > /dev/null 2>&1; then
            echo "‚úÖ GitHub Actions Redis (9091) Ïó∞Í≤∞ ÌôïÏù∏"
          else
            echo "‚ùå GitHub Actions Redis Ïó∞Í≤∞ Ïã§Ìå®"
            exit 1
          fi
          
          # Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú ÏÑúÎπÑÏä§ ÏãúÏûë (CI Ï†ÑÏö© compose ÏÇ¨Ïö©)
          echo "üì¶ FastAPI + RQ Worker Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë..."
          docker compose -f docker-compose.ci.yml up -d --build
          
          # ÏÑúÎπÑÏä§Îì§Ïù¥ Ï§ÄÎπÑÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
          echo "‚è≥ ÏÑúÎπÑÏä§ Ï§ÄÎπÑ ÎåÄÍ∏∞ Ï§ë..."
          sleep 30
          
          # Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
          echo "üîç Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏..."
          docker compose -f docker-compose.ci.yml ps
          
          # FastAPI ÏÑúÎπÑÏä§ Ï≤¥ÌÅ¨
          echo "üè• FastAPI ÏÑúÎπÑÏä§ Ï≤¥ÌÅ¨..."
          if docker compose -f docker-compose.ci.yml ps fastapi | grep -q "Up"; then
            echo "‚úÖ FastAPI Ïª®ÌÖåÏù¥ÎÑà Ï†ïÏÉÅ Ïã§Ìñâ Ï§ë"
          else
            echo "‚ùå FastAPI Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ Ïã§Ìå®"
            docker compose -f docker-compose.ci.yml logs fastapi
            exit 1
          fi
          
          # RQ Worker ÏÑúÎπÑÏä§ Ï≤¥ÌÅ¨
          echo "üè• RQ Worker ÏÑúÎπÑÏä§ Ï≤¥ÌÅ¨..."
          if docker compose -f docker-compose.ci.yml ps rq-worker | grep -q "Up"; then
            echo "‚úÖ RQ Worker Ïª®ÌÖåÏù¥ÎÑà Ï†ïÏÉÅ Ïã§Ìñâ Ï§ë"
          else
            echo "‚ùå RQ Worker Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ Ïã§Ìå®"
            docker compose -f docker-compose.ci.yml logs rq-worker
            exit 1
          fi
          
          # Redis ÌÅê Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ (Ïª®ÌÖåÏù¥ÎÑà ÎÇ¥Î∂ÄÏóêÏÑú)
          echo "üè• RQ Worker Redis Ïó∞Í≤∞ ÌÖåÏä§Ìä∏..."
          REDIS_TEST_CMD="import redis; import os; r = redis.Redis(host=os.getenv('REDIS_HOST'), port=int(os.getenv('REDIS_PORT'))); print('Redis ping:', r.ping())"
          if docker compose -f docker-compose.ci.yml exec -T rq-worker python -c "$REDIS_TEST_CMD" > /dev/null 2>&1; then
            echo "‚úÖ RQ WorkerÍ∞Ä RedisÏóê Ï†ïÏÉÅ Ïó∞Í≤∞Îê®"
          else
            echo "‚ùå RQ Worker Redis Ïó∞Í≤∞ Ïã§Ìå®"
            docker compose -f docker-compose.ci.yml logs rq-worker
            exit 1
          fi
          
          # ÏÑúÎπÑÏä§ Ï†ïÎ¶¨
          docker compose -f docker-compose.ci.yml down -v
          echo "‚úÖ RQ Worker ÌÜµÌï© ÌÖåÏä§Ìä∏ ÏôÑÎ£å"
        else
          echo "‚ö†Ô∏è docker-compose.ci.yml ÏóÜÏùå - Ïä§ÌÇµ"
        fi

# üöÄ Î∞∞Ìè¨ Í¥ÄÎ†® ÏÑπÏÖò (ÎÇòÏ§ëÏóê ÌïÑÏöîÏãú ÌôúÏÑ±Ìôî)
# 
# jobs:
#   deploy:
#     name: üöÄ ÏûêÎèô Î∞∞Ìè¨ & Ïû¨ÏãúÏûë
#     needs: test
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/main' && github.event_name == 'push'
#     
#     steps:
#     - name: üì• ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
#       uses: actions/checkout@v4
#       
#     - name: üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú & ÌÉúÍπÖ
#       run: |
#         VERSION_TAG=${GITHUB_SHA::8}-$(date +%Y%m%d%H%M)
#         docker build -t notion-lms:$VERSION_TAG .
#         docker tag notion-lms:$VERSION_TAG notion-lms:latest
#         echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV
#
#     - name: üîÑ ÏÑúÎ≤Ñ Î∞∞Ìè¨
#       uses: appleboy/ssh-action@v1.0.0
#       with:
#         host: ${{ secrets.DEPLOY_HOST }}
#         username: ${{ secrets.DEPLOY_USER }}
#         key: ${{ secrets.DEPLOY_SSH_KEY }}
#         script: |
#           docker pull notion-lms:latest
#           docker stop notion-lms || true
#           docker rm notion-lms || true
#           docker run -d --name notion-lms -p 8000:8000 notion-lms:latest 